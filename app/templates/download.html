<form 
    hx-post="/process-download" 
    hx-ext="json-enc" 
    hx-target="this"
    hx-swap="outerHTML"
    hx-disabled-elt="#download-btn"
    class="relative p-4 sm:p-6"
    hx-on::before-request="document.getElementById('download-error-container').innerHTML = ''"
    hx-on::response-error="document.getElementById('download-error-container').innerHTML = event.detail.xhr.responseText"
>
    {# HTMX loading indicator #}
    <div class="htmx-indicator hidden htmx-request:flex absolute inset-0 bg-gray-200 bg-opacity-75 items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <input type="hidden" name="url" value="{{ url }}">
    <div class="flex flex-col md:flex-row gap-4 md:gap-8">
        <div class="md:w-1/3 mb-6 md:mb-0">
            <h2 class="text-lg md:text-xl font-bold mb-4">{{ title }}</h2>
            <img src="{{ thumbnail }}" alt="{{ title }}" class="rounded-lg shadow-lg w-full">
        </div>
        <div class="md:w-2/3">
            <h3 class="text-lg md:text-xl font-semibold mb-4">Download Options</h3>
            
            {# Checkboxes for Video/Audio/Subtitles #}
            <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 mb-6">
                <div class="flex items-center">
                    <input type="checkbox" name="download_video" id="download_video" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" onchange="document.getElementById('video_quality_selector').style.display = this.checked ? 'block' : 'none'">
                    <label for="download_video" class="ml-2 block text-sm text-gray-900">Download Video</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="download_audio" id="download_audio" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="download_audio" class="ml-2 block text-sm text-gray-900">Download Audio</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="download_subtitles" id="download_subtitles" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="download_subtitles" class="ml-2 block text-sm text-gray-900">Download Subtitles</label>
                </div>
            </div>

            {# Video Quality and Output Format Selectors #}
            <div id="video_quality_selector" class="flex flex-col sm:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <label for="video_quality" class="block text-sm font-medium text-gray-700 mb-2">Video Quality</label>
                    <select name="video_quality" id="video_quality" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        {% set qualities = formats | selectattr('height') | map(attribute='height') | unique | sort(reverse=true) %}
                        {% for quality in qualities %}
                            <option value="{{ quality }}">{{ quality }}p</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-1">
                    <label for="output_format" class="block text-sm font-medium text-gray-700 mb-2">Output Format</label>
                    <select name="output_format" id="output_format" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="mp4">MP4</option>
                        <option value="mkv">MKV</option>
                        <option value="webm">WEBM</option>
                    </select>
                </div>
            </div>

            {# Download Button #}
            <div class="mt-6 text-center sm:text-right">
                {% if download_id and filename %}
                <a href="/download-file/{{ download_id }}/{{ filename }}" class="inline-block bg-green-500 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-green-600 w-full sm:w-auto">Click to Download</a>
                {% else %}
                <button type="submit" id="download-btn" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed htmx-request:bg-gray-400 htmx-request:cursor-not-allowed w-full sm:w-auto">
                    <span class="htmx-request:hidden">Download</span>
                    <span class="hidden htmx-request:inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    <div id="download-error-container" class="mt-4 text-red-500 font-medium"></div>
</form>
